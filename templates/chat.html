{% extends 'base.html' %}

{% block title %}Chat with Cogi{% endblock %}

{% block content %}
  
  <div class="chat-container">
    <!-- Message display area -->
    <div id="chat-box" class="chat-box">
      <!-- Initial welcome message -->
      <div class="chat-message bot-message fade-in">
        <div class="message-avatar">
          <i class="bi bi-robot"></i>
        </div>
        <div class="message-content">
          <div class="message-sender">Cogi</div>
          <div class="message-text">Hello {{first_name }} {{ last_name }} ! How can I help you today? I'm here to talk about whatever is on your mind.</div>
        </div>
      </div>
    </div>

    <!-- Message input field -->
    <div class="chat-input glass-card">
      <form id="message-form" class="input-group" autocomplete="off">
        <input type="text" id="user-input" class="form-control" placeholder="Type your message here..." autocomplete="off">
        
        <!-- Bouton micro pour speech-to-text -->
        <button type="button" id="mic-btn" class="btn btn-outline-secondary" title="Start/Stop voice input">
          <i class="bi bi-mic-fill"></i>
        </button>

        <button type="submit" id="send-btn" class="btn btn-love">
          <i class="bi bi-send-fill"></i> Send
        </button>
      </form>

      <div class="chat-suggestions mt-3">
        <span class="tag tag-love suggestionBtn">I feel anxious</span>
        <span class="tag tag-peace suggestionBtn">Breathing techniques</span>
        <span class="tag tag-harmony suggestionBtn">How can I improve my mood?</span>
      </div>
    </div>
  </div>

<script>
  // === Reconnaissance vocale avec Web Speech API ===
  const micBtn = document.getElementById('mic-btn');
  const userInput = document.getElementById('user-input');

  // Vérifier la compatibilité
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    micBtn.disabled = true;
    micBtn.title = "Speech Recognition not supported in this browser";
  } else {
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US'; // changer si besoin, par ex 'fr-FR' pour français
    recognition.interimResults = true; // afficher le texte en direct
    recognition.continuous = false; // arrêter après la phrase

    let recognizing = false;

    micBtn.addEventListener('click', () => {
      if (recognizing) {
        recognition.stop();
      } else {
        recognition.start();
      }
    });

    recognition.addEventListener('start', () => {
      recognizing = true;
      micBtn.classList.add('btn-danger'); // bouton rouge quand enregistrement
      micBtn.title = "Click to stop recording";
    });

    recognition.addEventListener('end', () => {
      recognizing = false;
      micBtn.classList.remove('btn-danger');
      micBtn.title = "Start voice input";
    });

    recognition.addEventListener('result', (event) => {
      let transcript = '';
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        transcript += event.results[i][0].transcript;
      }
      userInput.value = transcript;
    });
  }

  // === Le reste de ton JS existant pour envoyer les messages ===
  
  function sendMessage(message = null) {
    const input = document.getElementById("user-input");
    const userMessage = message || input.value.trim();
    
    if (userMessage === "") return; // Prevent sending an empty message

    appendMessage("You", userMessage, true);
    input.value = ""; 

    const typingIndicator = document.createElement("div");
    typingIndicator.id = "typing-indicator";
    typingIndicator.classList.add("chat-message", "bot-message", "fade-in");
    typingIndicator.innerHTML = `
      <div class="message-avatar">
        <i class="bi bi-robot"></i>
      </div>
      <div class="message-content">
        <div class="message-sender">Cogi</div>
        <div class="message-text typing-animation">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
      </div>
    `;
    document.getElementById("chat-box").appendChild(typingIndicator);
    scrollToBottom();

    fetch("/send_message", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({ 
        message: userMessage,
        system_message: "You are a psychological support assistant named Cogi. Remain calm, human, and attentive."
      })
    })
    .then(response => {
      if (!response.ok) throw new Error('Network error: ' + response.status);
      return response.json();
    })
    .then(data => {
      const indicator = document.getElementById("typing-indicator");
      if (indicator) indicator.remove();
      if (data.status === "error") {
        appendMessage("Cogi", "Sorry, an error occurred: " + data.error, false);
      } else {
        appendMessage("Cogi", data.response, false);
      }
    })
    .catch(error => {
      console.error("Error:", error);
      const indicator = document.getElementById("typing-indicator");
      if (indicator) indicator.remove();
      appendMessage("Cogi", "Sorry, an error occurred while communicating with the server. Please try again.", false);
    });
  }

  function appendMessage(sender, message, isUser) {
    const chatBox = document.getElementById("chat-box");
    const msg = document.createElement("div");
    msg.classList.add("chat-message", "fade-in");
    if (isUser) {
      msg.classList.add("user-message");
      msg.innerHTML = `
        <div class="message-content">
          <div class="message-sender">${sender}</div>
          <div class="message-text">${message}</div>
        </div>
        <div class="message-avatar">
          <i class="bi bi-person"></i>
        </div>
      `;
    } else {
      msg.classList.add("bot-message");
      msg.innerHTML = `
        <div class="message-avatar">
          <i class="bi bi-robot"></i>
        </div>
        <div class="message-content">
          <div class="message-sender">${sender}</div>
          <div class="message-text">${message}</div>
        </div>
      `;
    }
    chatBox.appendChild(msg);
    scrollToBottom();
  }

  function scrollToBottom() {
    const chatBox = document.getElementById("chat-box");
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  document.getElementById("message-form").addEventListener("submit", function(event) {
    event.preventDefault();
    sendMessage();
  });

  document.querySelectorAll(".suggestionBtn").forEach(btn => {
    btn.addEventListener("click", function() {
      sendMessage(this.textContent);
    });
  });

  window.onload = function() {
    document.getElementById("user-input").focus();
  };
</script>

{% endblock %}
